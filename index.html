<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  const TOTAL_SECTIONS = 13;
  const QUESTIONS_PER_SECTION = 10;
  const content = document.getElementById("content");
  const popup = document.getElementById("popup");
  const popupQuestion = document.getElementById("popup-question");
  const popupAnswer = document.getElementById("popup-answer");
  const popupTitle = document.getElementById("popup-title");
  const showAnswerBtn = document.getElementById("show-answer");
  const langSelect = document.getElementById("language-select");

  let currentAnswerPath = "";
  let currentLang = langSelect.value;

  // Create search and stats UI
  const toolbar = document.createElement("div");
  toolbar.style.display = "flex";
  toolbar.style.justifyContent = "space-between";
  toolbar.style.alignItems = "center";
  toolbar.style.marginBottom = "1rem";

  const searchInput = document.createElement("input");
  searchInput.type = "text";
  searchInput.placeholder = "Search questions...";
  searchInput.style.padding = "0.5rem";
  searchInput.style.flex = "1";
  searchInput.style.marginRight = "1rem";

  const statsDisplay = document.createElement("div");
  statsDisplay.style.fontWeight = "bold";

  toolbar.appendChild(searchInput);
  toolbar.appendChild(statsDisplay);
  content.before(toolbar);

  function updateStats() {
    let viewed = 0, answered = 0, total = TOTAL_SECTIONS * QUESTIONS_PER_SECTION;
    for (let section = 1; section <= TOTAL_SECTIONS; section++) {
      for (let index = 1; index <= QUESTIONS_PER_SECTION; index++) {
        const status = getStatus(section, ((section - 1) * QUESTIONS_PER_SECTION + index));
        if (status === "viewed") viewed++;
        if (status === "answered") answered++;
      }
    }
    statsDisplay.textContent = `Viewed: ${viewed}, Answered: ${answered}, Total: ${total}`;
  }

  function getStatus(section, index) {
    return localStorage.getItem(`status-${currentLang}-${section}-${index}`) || "not-viewed";
  }

  function setStatus(section, index, status) {
    localStorage.setItem(`status-${currentLang}-${section}-${index}`, status);
  }

  langSelect.addEventListener("change", () => {
    currentLang = langSelect.value;
    renderSections();
  });

  function renderSections() {
    content.innerHTML = "";
    for (let section = 1; section <= TOTAL_SECTIONS; section++) {
      const sec = document.createElement("div");
      sec.className = "section";
      sec.innerHTML = `
        <div class="section-header" data-section="${section}">Section ${section}</div>
        <div class="questions" id="questions-${section}"></div>
      `;
      content.appendChild(sec);
    }
    updateStats();
  }

  function statusToEmoji(status) {
    if (status === "answered") return "âœ… Answered";
    if (status === "viewed") return "ðŸŸ¢ Viewed";
    return "ðŸŸ¡ Not viewed";
  }

  document.addEventListener("click", async (e) => {
    if (e.target.classList.contains("section-header")) {
      const section = e.target.dataset.section;
      const container = document.getElementById(`questions-${section}`);

      if (container.innerHTML.trim() === "") {
        const startIndex = (section - 1) * QUESTIONS_PER_SECTION + 1;
        const endIndex = startIndex + QUESTIONS_PER_SECTION;
        for (let i = startIndex; i < endIndex; i++) {
          const qPath = `./${currentLang}/questions/section-${String(section).padStart(2, '0')}/question-${String(i).padStart(2, '0')}.md`;
          const aPath = `./${currentLang}/answers/section-${String(section).padStart(2, '0')}/answer-${String(i).padStart(2, '0')}.md`;

          try {
            const res = await fetch(qPath);
            if (!res.ok) continue;
            const status = getStatus(section, i);
            const div = document.createElement("div");
            div.className = "question-card";
            div.setAttribute("data-question", `section ${section} question ${i}`);
            div.innerHTML = `
              <div class="badge" id="badge-${section}-${i}">${statusToEmoji(status)}</div>
              <button data-q="${qPath}" data-a="${aPath}" data-section="${section}" data-index="${i}">Open Question ${i}</button>
            `;
            container.appendChild(div);
          } catch {}
        }
      }
      container.style.display = container.style.display === "grid" ? "none" : "grid";
    }

    if (e.target.tagName === "BUTTON" && e.target.dataset.q && e.target.dataset.a) {
      const section = e.target.dataset.section;
      const index = e.target.dataset.index;
      const qRes = await fetch(e.target.dataset.q);
      const qText = await qRes.text();
      popupTitle.textContent = `Section ${section} â€” Question ${index}`;
      popupQuestion.innerHTML = marked.parse(qText);
      popupAnswer.innerHTML = "";
      popupAnswer.style.display = "none";
      currentAnswerPath = e.target.dataset.a;
      popup.showModal();

      const badge = document.getElementById(`badge-${section}-${index}`);
      if (badge) badge.textContent = "ðŸŸ¢ Viewed";
      setStatus(section, index, "viewed");
      updateStats();
    }

    if (e.target.id === "show-answer") {
      fetch(currentAnswerPath)
        .then(res => res.text())
        .then(md => {
          popupAnswer.innerHTML = marked.parse(md);
          popupAnswer.style.display = "block";

          const match = currentAnswerPath.match(/section-(\d+).*answer-(\d+)\.md$/);
          if (match) {
            const section = match[1];
            const index = match[2];
            const badge = document.getElementById(`badge-${section}-${index}`);
            if (badge) badge.textContent = "âœ… Answered";
            setStatus(section, index, "answered");
            updateStats();
          }
        });
    }
  });

  searchInput.addEventListener("input", () => {
    const query = searchInput.value.toLowerCase();
    const cards = document.querySelectorAll(".question-card");
    cards.forEach(card => {
      const match = card.getAttribute("data-question").toLowerCase().includes(query);
      card.style.display = match ? "block" : "none";
    });
  });

  renderSections();
</script>
